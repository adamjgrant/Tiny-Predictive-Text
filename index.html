<!DOCTYPE HTML>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<h2>Tiny Predictive Text
<br><small>Experiment using a decaying context window</small></h2>
<p>Press <strong>Tab</strong> to autocomplete with suggestion.<br>
   Press <strong>Shift</strong> to change the suggestion</p>
<p id="loading" class="loading">Loading model...This could take about 10-30 seconds depending on your connection...</p>
<div id="suggestion">...</div>

<template id="secondary-suggestions">
  <span class="secondary-suggestion"></span>
</template>

<div id="other-suggestions" class="other-suggestions"></div>
 
<textarea id="entry" class="entry" placeholder="Start typing"></textarea>
<p>
  <br>Context string: <code><span id="cs-layer1">...</span> --> <span id="cs-layer2">...</span> --> <span id="cs-layer3">...</span></code>
</p>

<p>
  <div class="color_box" style="background-color: rgb(187, 246, 187)"></div> Light green = Good.<br>
  <div class="color_box" style="background-color: #00cc00"></div> Green = Better<br>
  <div class="color_box" style="background-color: darkgreen"></div> Dark green = Best<br>
  <div class="color_box" style="background-color: #EEEEEE;"></div> White = Matching within prediction<br>
  <div class="color_box" style="background-color: cornflowerblue;"></div> Blue = Idle
</p>
<script type="module" src="tinypredict.js"></script>
<script>
  const suggestion_element = document.getElementById('suggestion');
  const other_suggestions = document.getElementById('other-suggestions');

  const set_suggestion_element = () => {
    other_suggestions.innerHTML = '';

    if (predictions_on_deck.length === 0) {
      suggestion_element.innerHTML = '...';
      return;
    }
    suggestion_element.innerHTML = predictions_on_deck[0];
    /*
    other_suggestions = predictions_on_deck.splice(1, predictions_on_deck.length - 1);

    other_suggestions.forEach(suggestion => {
      const secondary_suggestion = copy_from_template("secondary-suggestions");
      secondary_suggestion.innerHTML = suggestion;
      other_suggestions.appendChild(secondary_suggestion);
    });
    */
  }

  let predictions_on_deck = [];

  const completeSuggestion = () => {
    if (predictions_on_deck.length === 0) {
      return;
    }
    const entry = document.getElementById('entry');
    entry.value += predictions_on_deck[0] + " ";
    predictions_on_deck = [];
    set_suggestion_element();
  }

  // Copy <templates> by ID.
  const copy_from_template = (template_id) => document.getElementById(template_id).content.cloneNode(true).firstElementChild;

  const cs_layer1 = document.getElementById('cs-layer1');
  const cs_layer2 = document.getElementById('cs-layer2');
  const cs_layer3 = document.getElementById('cs-layer3');
  const set_debugger = (suggestions) => {
    cs_layer1.innerHTML = suggestions.second_level_context;
    cs_layer2.innerHTML = suggestions.first_level_context;
    cs_layer3.innerHTML = suggestions.anchor
  }

  window.addEventListener('tinypredict-ready', () => {
    document.body.classList.add('loaded');

    const entry = document.getElementById('entry');
    entry.addEventListener("keydown", function(event) {
      if (event.key === "Tab") {
        event.preventDefault();
        completeSuggestion();
      }
    });
    entry.addEventListener("keyup", function(event) {
      const input = event.target.value;
      if (event.key === "Shift") {
        event.preventDefault();
        console.log(predictions_on_deck);
        predictions_on_deck.push(predictions_on_deck.shift());
        console.log(predictions_on_deck);
        set_suggestion_element();
      }
      else {
        window.getPredictiveText(input).then(suggestions => {
          console.log(suggestions.prediction); // Process or display the suggestions
          set_debugger(suggestions);
          predictions_on_deck = suggestions.prediction;
          set_suggestion_element();
        });
      }
    });
  });
</script>

<!-- Note to self, look at the debugger, it's not actually capturing the context letters correctly -->

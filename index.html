<!DOCTYPE HTML>
<head>
    <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js"></script>
    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/pace-theme-default.min.css"-->
    <link rel="stylesheet" href="loading-bar.css">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
</head>
<h2>Tiny Predictive Text
<br><small>Experiment using a decaying context window</small></h2>
<p>Press <strong>Tab</strong> to autocomplete with suggestion.<br>
   Press <strong>Shift</strong> to change the suggestion</p>
<p id="loading" class="loading">Loading model...</p>
<div id="suggestion">...</div>

<template id="secondary-suggestions">
  <span class="secondary-suggestion"></span>
</template>

<div id="other-suggestions" class="other-suggestions"></div>
 
<div id="entry" class="entry" contenteditable="true" placeholder="Start typing"></div>
<p>
  <br>Context string: <code><span id="cs-layer1">...</span> --> <span id="cs-layer2">...</span> --> <span id="cs-layer3">...</span></code>
</p>

<p>
  <div class="color_box" style="background-color: rgb(187, 246, 187)"></div> Light green = Good.<br>
  <div class="color_box" style="background-color: #00cc00"></div> Green = Better<br>
  <div class="color_box" style="background-color: darkgreen"></div> Dark green = Best<br>
  <div class="color_box" style="background-color: #EEEEEE;"></div> White = Matching within prediction<br>
  <div class="color_box" style="background-color: cornflowerblue;"></div> Blue = Idle
</p>
<script type="module" src="dist/tinypredict.js"></script>
<script>
  const suggestion_element = document.getElementById('suggestion');
  const other_suggestions_element = document.getElementById('other-suggestions');

  set_suggestion_element_color = (object) => {
    const ENUM = { GOOD: "good", BETTER: "better", BEST: "best", IDLE: "idle", INSIDE_PREDICTION: "inside_prediction" }
    for (let key in ENUM) { let color = ENUM[key]; suggestion_element.classList.remove(`color-${color}`); }

    let context_length = `${object.second_level_context}${object.first_level_context}`.length;
    if (context_length === 6) color_to_use = ENUM.BEST;
    else if (context_length > 3) color_to_use = ENUM.BETTER;
    else if (context_length > 0) color_to_use = ENUM.GOOD;
    else color_to_use = ENUM.IDLE;
    suggestion_element.classList.add(`color-${color_to_use}`); 
  }

  const set_suggestion_element = () => {
    other_suggestions_element.innerHTML = '';

    if (predictions_on_deck.length === 0 || predictions_on_deck[0] === "" || predictions_on_deck[0] === undefined) {
      suggestion_element.innerHTML = '...';
      return;
    }
    suggestion_element.innerHTML = predictions_on_deck[0];
    
    let other_suggestions = predictions_on_deck.slice(1, predictions_on_deck.length);

    other_suggestions.forEach(suggestion => {
      let secondary_suggestion = copy_from_template("secondary-suggestions");
      secondary_suggestion.innerHTML = suggestion;
      other_suggestions_element.appendChild(secondary_suggestion);
    });

    const existing_ghost = document.getElementById('suggestion_ghost');
    if (existing_ghost) existing_ghost.parentElement.removeChild(existing_ghost);
    const suggestion_element_as_span = document.createElement('span');
    suggestion_element_as_span.innerHTML = predictions_on_deck[0];
    suggestion_element.classList.add("ghost");
    suggestion_element.contentEditable = false;
    suggestion_element.id = "suggestion_ghost";

    entry.appendChild(suggestion_element_as_span);
  }

  let predictions_on_deck = [];

  const completeSuggestion = () => {
    if (predictions_on_deck.length === 0) {
      return;
    }
    const entry = document.getElementById('entry');
    const space = entry.innerText.endsWith(" ") ? "" : " ";
    entry.innerText += space + predictions_on_deck[0].trim() + " ";
    predictions_on_deck = [];
    set_suggestion_element();
    moveCursorToEnd(entry);
  }

  // Copy <templates> by ID.
  const copy_from_template = (template_id) => document.getElementById(template_id).content.cloneNode(true).firstElementChild;

  const cs_layer1 = document.getElementById('cs-layer1');
  const cs_layer2 = document.getElementById('cs-layer2');
  const cs_layer3 = document.getElementById('cs-layer3');
  const set_debugger = (suggestions) => {
    cs_layer1.innerHTML = suggestions.second_level_context;
    cs_layer2.innerHTML = suggestions.first_level_context;
    cs_layer3.innerHTML = suggestions.anchor
  }

  function moveCursorToEnd(contentEditableElement) {
      // Ensure the element is focusable
      contentEditableElement.focus();
      
      // Create a range object
      var range = document.createRange();
      var selection = window.getSelection();
      
      // Set the range to the end of the content
      range.selectNodeContents(contentEditableElement);
      range.collapse(false); // false collapses the range to its end
      
      // Remove any existing selections
      selection.removeAllRanges();
      
      // Add the new range
      selection.addRange(range);
  }


  window.addEventListener('tinypredict-ready', () => {
    document.body.classList.add('loaded');

    const entry = document.getElementById('entry');
    entry.addEventListener("keydown", function(event) {
      if (event.key === "Tab") {
        event.preventDefault();
        completeSuggestion();
      }
    });
    entry.addEventListener("keyup", function(event) {
      punctuation_regex = /[.\?&\*;:{}=\-_`~()]+/g;
      const input = event.target.innerText.split(punctuation_regex).pop().trim();
      if (event.key === "Shift") {
        event.preventDefault();
        predictions_on_deck.push(predictions_on_deck.shift());
        set_suggestion_element();
      }
      else {
        window.getPredictiveText(input).then(suggestions => {
          set_debugger(suggestions);
          predictions_on_deck = suggestions.prediction;
          set_suggestion_element();
          set_suggestion_element_color(suggestions);
        });
      }
    });
  });
</script>